<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Java 17</title>

		<link rel="stylesheet" href="../reveal.js/dist/reset.css">
		<link rel="stylesheet" href="../reveal.js/dist/reveal.css">
		<link rel="stylesheet" href="../reveal.js/dist/theme/black.css" id="theme">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="../reveal.js/plugin/highlight/monokai.css" id="highlight-theme">
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
                <!-- Slides are separated by newline + three dashes + newline, vertical slides identical but two dashes -->
                <section data-markdown data-separator="^\n---\n$" data-separator-vertical="^\n--\n$">
					<textarea data-template>
					<!-- ## Java 17 -->	
					![Java logo](images/java_small.png)
					## New features in Java 17

					--

					## Wie zijn wij?

					Robbin Troost

					Java Developer

					Aegon Hypotheken

					Notes:
					* IT-for-IT bij Aegon Hypotheken
					* 26 jaar woonachtig in Leersum
					* Java Masterclass.

					--
					
					## Wie zijn wij?

					Joost van Gils
					
					Java Developer
					
					Payments Gladiators

					Notes:
					* 50 years old, father of 3 sons, Almere
					* Java since 2001 (Java 1.3), also Scala + functional programming style
					* At AA since November 2022
					* Hobbies: tech, music (midi), home automation		
					
					---

					## Stukje geschiedenis
					
					--

					## Java is bijna 27 jaar oud

					| versie       | release date    | support eindigt |
					| ------------ |:---------------:| ---------------:|
					| 1.0     	   | 23-01-1996      | ?               |
					| SE 5	       | 29-09-2009      | April 2015      |
					| SE 8 (LTS)   | 18-03-2014      | December 2030   |
					| SE 11 (LTS)  | 25-09-2018      | September 2026  |
					| *SE 17 (LTS)  | 14-09-2021     | September 2029  |
					| SE 21 (LTS)  | 19-09-2023      | September 2031  |

					Notes:
					Oracle. Azul, Red Hat, etc dates differ

					--

					## Features
					| version      | features                                 |
					| --- |:----------------------------------------:|
					| 5	  | generics, annotations, enums, autoboxing, vararg, static imports |
					| 8   | lambdas, stream API, java.nio (7), default methods    |
					| 11  | var keyword (10), http client, lambda local var syntax  |

					---

					## Wat gaan we bekijken?

					* Records
					* Pattern matching
					* Text blocks
					* Helpful NPEs
					* Switch expressions
					* Sealed classes
					* Improved Stream API
					* Vector API (incubator)
					* Foreign Function and Memory Access API (incubator)

					--

					## Records

					--

					```java
					public record Point(long x, long y) {
						// nothing to see here
					}
					```

					--

					* Gelijkwaardig aan Lombok's @Value

					* Implicit	
						* all-args constructor
						* getters voor alle velden
						* `equals` en `hashcode` method
						* `toString` method

					* Geen extends mogelijk. Hiervoor is Lombok weer handig.

					* Efficient op de JVM

					Notes:
					* Lombok wordt ook veel gebruikt voor het builder pattern.
					De technieken zijn niet exclusief, maar vullen elkaar aan.

					--
					```java
					public record Point(long x, long y) {
						// nothing to see here
					}
					```
					```java
					var p = new Point(10, 20);
					var q = new Point(10, 20);
					```
					```java
					System.out.println( p );
					System.out.println( p.x() );
					System.out.println( p.equals(q) );
					```
					```sh
					Point[x=10, y=20]
					10
					true
					```

					---

					## Pattern matching (instanceOf)

					Notes:
					Pattern matching involves testing whether an object has a particular structure,
						then extracting data from that object if there's a match.

					--

					Java 11
					```java
					if (obj instanceof String) {
						String s = (String) obj;
						System.out.println(s.length());
					}
					```
					Java 17
					```java
					if (obj instanceof String s) {
						System.out.println(s.length());
					}
					```

					--

					### Pattern matching voor records (JDK 21)

					--

					Java 17

					```java
					record Point(int x, int y) {}
					```

					```java
					static void printSum(Object o) {
						if (o instanceof Point p) {
							int x = p.x();
							int y = p.y();
							System.out.println(x+y);
						}
					}
					```

					Java 21
					```java
					record Point(int x, int y) {}

					void printSum(Object o) {
						if (o instanceof Point(int x, int y)) {
							System.out.println(x+y);
						}
					}
					```

					---

					## Text blocks

					--

					Java 11
					```java
					String html = 
						"<html>\n" +
						"    <body>\n" +
						"        <em>Cool LTS Java 17 Features</em>\n" +
						"    </body>\n" +
						"</html>\n";
					```
					Java 17
					```java
					String html = """
							<html>
								<body>
									<em>Cool LTS Java 17 Features</em>
								</body>
							</html>
							""";
					```

					---

					## Helpful NullPointerExceptions

					--

					Java 11
					```java
					var street = customer.getAddress().getStreet();
					```
					```sh
					Exception in thread "main" java.lang.NullPointerException
						at com.abnamro/com.company.App.main(App.java:17)
					```

					--

					Java 17
					```java
					var street = customer.address().street();
					```
					```sh
					Exception in thread "main" java.lang.NullPointerException:
					Cannot invoke "com.company.Address.street()" because the
					return value of "com.company.Customer.address()" is null
						at com.abnamro.Application.main(App.java:21)
					```

					---

					## Switch expression

					--

					```java
					int numDays = switch(month) {
						case JAN, MAR, MAY, JUL, AUG, OCT, DEC -> 31;
						case APR, JUN, SEP, NOV -> 30;
						case FEB -> {
							if (year % 400 == 0) yield 29;
							else if (year % 100 == 0) yield 28;
							else if (year % 4 == 0) yield 29;
							else yield 28;
						}
					};
					```
					* een *expression*, niet een *statement*
					* voorkomt fall-through (`break`)
					* pattern matching
					* yield produceert een value voor een block (geen return!)

					Notes:
					Een expressie produceert altijd een resultaat, een statement niet (bijv. een void call)
					---

					## Sealed classes
					(Java 17)

					--
					
					```java
					public abstract sealed class Animal
						permits Dog, Cat {
					}	
					
					public final class Dog extends Animal {
					}	
					
					public final class Cat extends Animal {
					}
					```

					--

					Handig voor:
					* `switch` zonder `default` case
					* checken of alle `if/then/else` statements zijn doorlopen (compiler doet dit)

					Notes:
					* Open-closed principle?
					* Design for extension, else prohibit it?

					---

					## Improved streams API

					--

					Voorheen:
					```java
					var list = stream.collect(Collectors.toList())
					```

					wordt:

					```java
					var list = stream.toList();
					```

					Let op: `toList()` geeft een immutable List

					---

					## Vector API (incubator)

					--

					* Vierde incubator, dus vrij complex (sinds 2018)
					* Meerdere berekeningen in een enkele CPU-cycle (SIMD)
					* Sneller dan equivalente scalar operations
					* Platform-agnostisch
					* Auto vectorisation

					--

					Voorheen:

					```java
					s[0] = s[0] + v[0];
					s[1] = s[1] + v[1];
					s[2] = s[2] + v[2];
					s[3] = s[3] + v[3];
					```

					Java 16+
					```java
					float[] a = new float[] {1f, 2f, 3f, 4f}; // 4 x 32 bits
					float[] b = new float[] {5f, 8f, 10f, 12f}; // 4 x 32 bits

					FloatVector first = FloatVector.fromArray(FloatVector.SPECIES_128, a, 0); // 128 bits want 4x32, 0 offset
					FloatVector second = FloatVector.fromArray(FloatVector.SPECIES_128, b, 0); // 128 bits want 4x32, 0 offset

					FloatVector result = first
							.add(second)
							.pow(2)
							.neg();
					```

					---

					## Foreign Function and Memory Access API (incubator)

					--

					* Backbone voor o.a. de Vector API
					* Momenteel alleen C-libraries
					* Voorheen JNI, maar vrij beperkt
					* Functie calls en memory buiten de JVM uitvoeren en aanspreken
					* Efficient en veilig

					Notes:
					* Bij JNI moest het JVM/platform-specific gecompiled worden om met elkaar te laten werken

					--

					Off-memory gebruiken:

					```java
					// Allocate off-heap memory to store four pointers
					String[] javaStrings = { "mouse", "cat", "dog", "car" };

					MemorySegment offHeap = MemorySegment.allocateNative(
						MemoryLayout.ofSequence(javaStrings.length,CLinker.C_POINTER));
					```


					Een externe C-functie aanroepen:
					```java
					MethodHandle radixSort = CLinker.getInstance().downcallHandle(
						CLinker.systemLookup().lookup("radixsort"), ...);

					radixSort.invoke(offHeap.address(), javaStrings.length,
						MemoryAddress.NULL, '\0');
					```

					---

					## Waarom (geen) Java 17 gebruiken

					--

					## Cons
					* Requires new skills, also for future maintainers
					* Infra might not be up to date (IDE, SonarQube, build agents, live environments)
					* Existing projects: not enough benefit to migrate
					* Libraries that do not work on a Java 17 JVM
					* It might be scary to do things differently

					--

					## Pros
					* Many bug fixes and security improvements
					* Premier support for Java 11 ends Sept 2023
					* Instant performance boost
  						Java 17 is about 8.5% faster than Java 11 on G1 GC and 6.5% on parallel GC ([source](https://www.optaplanner.org/blog/2021/09/15/HowMuchFasterIsJava17.html)).
					* Spring Boot 3+ requires it
					* No need to use new features immediately
					* It's fun to use new things!

					---

					![Java logo](images/java_small.png)
					##  Spring Boot 3

					--

					Migratie bij Aegon Hypotheken

					--

					* Algemene aanpak incl. Java 17
					* WebMVC controller changes
					* Bootstrap properties
					* Spring.factories

					--

					Stack
					* Maven
					* SonarQube 8.9.10 Enterprisie
					* Kubernetes op AWS
					* Docker containers voor deployment en microservice
					* Parent pom voor versiebeheer richting teams

					--

					Vragen
					* Support SonarQube Java 17?
					* Hoe ondersteunen we versie 11 en 17 tegelijk?
					* Hoe zorgen we dat teams vooruitgaan naar versie 17?

					--

					* Build container: versie 11 en 17 ondersteunen via SDKman
					* De parent pom bevat een <java.version> die zich vertaalt naar een compiler target.
					* In pipeline: target bepalen via POM

					```bash
					COMPILER_TARGET=$(mvn help:evaluate
						-Dexpression="maven.compiler.target" \
						--batch-mode
						-DforceStdout \
						-q)
					```

					```bash
					JAVA_HOME="$SDKMAN_DIR/candidates/java/${COMPILER_TARGET}"
					echo "Setting home to $JAVA_HOME"
					echo "##vso[task.setvariable variable=JAVA_HOME]$JAVA_HOME"
					```

					---

					WebMVC controller changes

					--

					```java
					@RestController
					public class MyController {
					  @GetMapping("/some/greeting")
					  public String greeting() {
						return "Hello";
					  }
					}
					```

					Terugzetten oude gedrag:
					```java
					@Configuration
					public class WebConfiguration implements WebMvcConfigurer {
						@Override
						public void configurePathMatch(PathMatchConfigurer configurer) {
						  configurer.setUseTrailingSlashMatch(true);
						}
					}
					```

					--

					Spring.factories deprecation (2.4x)

					--

					* Voorheen:
					```java
					resources/META-INF/spring.factories
					```

					Configuratie:
					```java
					org.springframework.boot.autoconfigure.EnableAutoConfiguration=xxx
					```

					En de autoconfiguratie:
					```java
					@ComponentScan("com.aegon.commons.amqp")

					@PropertySource('...')

					public class { /* ....*/ }

					```

					* Vanaf spring 2.7:
					```java
					META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports
					```

					* Vanaf Spring 3.0: geen spring.factories support meer

					---

					## Thank you!
					joost.van.gils@nl.abnamro.com
					robbin.troost@aegon.nl

					</textarea>
				</section>
			</div>
		</div>

		<script src="../reveal.js/dist/reveal.js"></script>
		<script src="../reveal.js/plugin/notes/notes.js"></script>
		<script src="../reveal.js/plugin/markdown/markdown.js"></script>
		<script src="../reveal.js/plugin/highlight/highlight.js"></script>
		<script>
			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
				navigationMode: 'linear',
				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes ]
			});
		</script>
	</body>
</html>
